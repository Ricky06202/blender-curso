---
import Layout from '../../layouts/Layout.astro'
import { getChapters, getChapterById, type Chapter } from '../../lib/api'
import ChapterProgress from '../../components/ChapterProgress.tsx'

export async function getStaticPaths() {
  const capitulos = await getChapters()
  return capitulos.map((c) => ({
    params: { id: c.slug },
    props: { capitulos },
  }))
}

const { id } = Astro.params
const capitulos = (await Astro.props.capitulos) || []
const chapterSlug = id
const cap =
  capitulos.find((c: Chapter) => c.slug === chapterSlug) ||
  (await getChapterById(chapterSlug).catch(() => null))

if (!cap) {
  const firstChapter = capitulos[0]
  if (firstChapter) {
    return Astro.redirect(`/capitulos/${firstChapter.id}`)
  }
  return Astro.redirect('/404')
}
---

<Layout>
  <div
    id="top"
    class="grid grid-cols-1 md:grid-cols-[280px_1fr] gap-4 max-w-[1200px] mx-auto p-4 items-start"
  >
    <aside
      class="md:sticky md:top-0 self-start p-4 pr-3 border-r border-slate-200 bg-white"
    >
      <h1 class="text-lg font-medium m-0 mb-2">Cap√≠tulos</h1>
      <ChapterProgress client:load chapters={capitulos} currentChapterId={cap.id} />
    </aside>

    <main class="">
      <section class="bg-white border border-slate-200 rounded-xl px-4">
        <h2 class="m-0 mb-1 text-2xl font-semibold">{cap?.title}</h2>
        <p class="m-0 mb-4 text-slate-600">{cap?.description}</p>

        {
          cap?.videoUrl && (
            <div class="aspect-video w-full overflow-hidden rounded-lg border border-slate-200 bg-black/5">
              <iframe
                class="w-full h-full"
                src={cap?.videoUrl}
                title={cap?.title}
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
              />
            </div>
          )
        }
      </section>
    </main>
  </div>
</Layout>
